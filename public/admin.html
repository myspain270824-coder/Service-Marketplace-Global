<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Админка заявок | Service Marketplace Global</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #050816;
      color: #e5e7eb;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px 16px 80px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 24px;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
    }

    select,
    button {
      border-radius: 9999px;
      padding: 8px 16px;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }

    select {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #374151;
      color: #e5e7eb;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }

    th,
    td {
      border-bottom: 1px solid #1f2937;
      padding: 10px 8px;
    }

    th {
      text-align: left;
      color: #9ca3af;
      font-weight: 500;
      background: #020617;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.6);
    }

    tr:nth-child(odd) td {
      background: rgba(15, 23, 42, 0.3);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-new {
      background: rgba(59, 130, 246, 0.15);
      color: #60a5fa;
    }

    .status-in_progress {
      background: rgba(234, 179, 8, 0.15);
      color: #facc15;
    }

    .status-done {
      background: rgba(34, 197, 94, 0.15);
      color: #4ade80;
    }

    .status-canceled {
      background: rgba(248, 113, 113, 0.15);
      color: #fca5a5;
    }

    .small {
      font-size: 12px;
      color: #9ca3af;
    }

    .table-wrapper {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid #1f2937;
      background: radial-gradient(circle at top left, #111827, #020617);
    }

    .footer-info {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
    }

    /* Модалка "Подробнее" */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal {
      width: 100%;
      max-width: 520px;
      background: #020617;
      border-radius: 18px;
      border: 1px solid #1f2937;
      padding: 20px 20px 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }

    .close-btn {
      border-radius: 9999px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      font-size: 20px;
      line-height: 1;
      padding: 4px 8px;
    }

    .close-btn:hover {
      background: #111827;
      color: #e5e7eb;
    }

    .modal-body {
      font-size: 14px;
      display: grid;
      row-gap: 6px;
    }

    .modal-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .modal-value {
      margin-bottom: 4px;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 12px;
      padding-top: 8px;
      border-top: 1px solid #111827;
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px 8px 64px;
      }

      h1 {
        font-size: 22px;
      }

      table {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Заявки клиентов</h1>

    <div class="toolbar">
      <label>
        Фильтр по статусу:
        <select id="statusFilter">
          <option value="all">Все</option>
          <option value="new">Новые</option>
          <option value="in_progress">В работе</option>
          <option value="done">Завершённые</option>
          <option value="canceled">Отменённые</option>
        </select>
      </label>

      <button class="btn-primary" id="refreshBtn">Обновить</button>
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Услуга</th>
            <th>Клиент</th>
            <th>Контакт</th>
            <th>Город</th>
            <th>Комментарий</th>
            <th>Создана</th>
            <th>Статус</th>
            <th>Действие</th>
          </tr>
        </thead>
        <tbody id="requestsBody">
          <!-- строки заявок -->
        </tbody>
      </table>
    </div>

    <div class="footer-info">
      <span id="countLabel">Заявок загружено: 0</span>
    </div>
  </div>

  <!-- Модальное окно "Подробнее" -->
  <div id="requestModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="modalTitle">Заявка</div>
          <div class="small" id="modalSubtitle"></div>
        </div>
        <button class="close-btn" id="modalCloseBtn">&times;</button>
      </div>

      <div class="modal-body">
        <div>
          <div class="modal-label">Услуга</div>
          <div class="modal-value" id="modalService"></div>
        </div>

        <div>
          <div class="modal-label">Клиент</div>
          <div class="modal-value" id="modalCustomer"></div>
        </div>

        <div>
          <div class="modal-label">Контакт</div>
          <div class="modal-value" id="modalContact"></div>
        </div>

        <div>
          <div class="modal-label">Город / район</div>
          <div class="modal-value" id="modalCity"></div>
        </div>

        <div>
          <div class="modal-label">Комментарий</div>
          <div class="modal-value" id="modalComment"></div>
        </div>

        <div>
          <div class="modal-label">Статус</div>
          <div class="modal-value" id="modalStatus"></div>
        </div>

        <div>
          <div class="modal-label">Описание услуги</div>
          <div class="modal-value" id="modalServiceDescription"></div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-secondary" id="modalCloseBottom">Закрыть</button>
      </div>
    </div>
  </div>

  <script>
    const statusFilter = document.getElementById('statusFilter');
    const refreshBtn = document.getElementById('refreshBtn');
    const requestsBody = document.getElementById('requestsBody');
    const countLabel = document.getElementById('countLabel');

    // элементы модалки
    const modalBackdrop = document.getElementById('requestModalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalSubtitle = document.getElementById('modalSubtitle');
    const modalService = document.getElementById('modalService');
    const modalCustomer = document.getElementById('modalCustomer');
    const modalContact = document.getElementById('modalContact');
    const modalCity = document.getElementById('modalCity');
    const modalComment = document.getElementById('modalComment');
    const modalStatus = document.getElementById('modalStatus');
    const modalServiceDescription = document.getElementById('modalServiceDescription');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalCloseBottom = document.getElementById('modalCloseBottom');

    function formatDate(isoString) {
      if (!isoString) return '-';
      const d = new Date(isoString);
      const dd = String(d.getDate()).padStart(2, '0');
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const yyyy = d.getFullYear();
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      return `${dd}.${mm}.${yyyy}, ${hh}:${min}`;
    }

    function renderStatusBadge(status) {
      const span = document.createElement('span');
      span.classList.add('status-badge');

      switch (status) {
        case 'new':
          span.classList.add('status-new');
          span.textContent = 'Новая';
          break;
        case 'in_progress':
          span.classList.add('status-in_progress');
          span.textContent = 'В работе';
          break;
        case 'done':
          span.classList.add('status-done');
          span.textContent = 'Завершена';
          break;
        case 'canceled':
          span.classList.add('status-canceled');
          span.textContent = 'Отменена';
          break;
        default:
          span.textContent = status || '-';
      }

      return span;
    }

    async function loadRequests() {
      const status = statusFilter.value;
      const url =
        status === 'all'
          ? '/api/requests'
          : `/api/requests?status=${encodeURIComponent(status)}`;

      const res = await fetch(url);
      const data = await res.json();

      requestsBody.innerHTML = '';
      countLabel.textContent = `Заявок загружено: ${data.length}`;

      for (const r of data) {
        const tr = document.createElement('tr');

        const tdId = document.createElement('td');
        tdId.textContent = r.id;

        const tdService = document.createElement('td');
        tdService.innerHTML = `${r.service_name || '—'}<div class="small">service_id: ${r.service_id}</div>`;

        const tdCustomer = document.createElement('td');
        tdCustomer.textContent = r.customer_name || '—';

        const tdContact = document.createElement('td');
        tdContact.textContent = r.customer_contact || '—';

        const tdCity = document.createElement('td');
        tdCity.textContent = r.city || '—';

        const tdComment = document.createElement('td');
        tdComment.textContent = r.comment || '—';

        const tdCreated = document.createElement('td');
        tdCreated.textContent = formatDate(r.created_at);

        const tdStatus = document.createElement('td');
        tdStatus.appendChild(renderStatusBadge(r.status));

        const tdActions = document.createElement('td');

        // селект для статуса
        const select = document.createElement('select');
        select.innerHTML = `
          <option value="new">Новая</option>
          <option value="in_progress">В работе</option>
          <option value="done">Завершена</option>
          <option value="canceled">Отменена</option>
        `;
        select.value = r.status || 'new';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Сохранить';
        saveBtn.classList.add('btn-primary');
        saveBtn.style.marginLeft = '6px';

        saveBtn.addEventListener('click', async () => {
          await updateStatus(r.id, select.value);
          await loadRequests();
        });

        const detailsBtn = document.createElement('button');
        detailsBtn.textContent = 'Подробнее';
        detailsBtn.classList.add('btn-secondary');
        detailsBtn.style.marginLeft = '6px';

        detailsBtn.addEventListener('click', () => openDetails(r.id));

        tdActions.appendChild(select);
        tdActions.appendChild(saveBtn);
        tdActions.appendChild(detailsBtn);

        tr.appendChild(tdId);
        tr.appendChild(tdService);
        tr.appendChild(tdCustomer);
        tr.appendChild(tdContact);
        tr.appendChild(tdCity);
        tr.appendChild(tdComment);
        tr.appendChild(tdCreated);
        tr.appendChild(tdStatus);
        tr.appendChild(tdActions);

        requestsBody.appendChild(tr);
      }
    }

    async function updateStatus(id, status) {
      await fetch(`/api/requests/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status }),
      });
    }

    async function openDetails(id) {
      const res = await fetch(`/api/requests/${id}`);
      if (!res.ok) {
        alert('Не удалось загрузить заявку');
        return;
      }

      const r = await res.json();

      modalTitle.textContent = `Заявка #${r.id}`;
      modalSubtitle.textContent = `Создана: ${formatDate(r.created_at)}`;

      modalService.textContent = r.service_name || `service_id: ${r.service_id}`;
      modalCustomer.textContent = r.customer_name || '—';
      modalContact.textContent = r.customer_contact || '—';
      modalCity.textContent = r.city || '—';
      modalComment.textContent = r.comment || '—';

      modalStatus.innerHTML = '';
      modalStatus.appendChild(renderStatusBadge(r.status));

      modalServiceDescription.textContent =
        r.service_description || 'Описание услуги пока не указано.';

      modalBackdrop.style.display = 'flex';
    }

    function closeModal() {
      modalBackdrop.style.display = 'none';
    }

    refreshBtn.addEventListener('click', loadRequests);
    statusFilter.addEventListener('change', loadRequests);
    modalCloseBtn.addEventListener('click', closeModal);
    modalCloseBottom.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    // начальная загрузка
    loadRequests();
  </script>
</body>
</html>
